bundle:
  name: bds-qa-bundle

variables:
  ENV_NAME:
    description: ENV_NAME
  BUNDLE_VAR_ENV_NAME:
    description: BUNDLE_VAR_ENV_NAME

include:
  - "./jobs/bundle*.yml"

.job_cluster: &job_cluster
  new_cluster:
    init_scripts:
      - workspace:
          destination: /Shared/scripts/cluster-init.sh
    enable_elastic_disk: true
    spark_env_vars:
      DATABRICKS_HOST: "{{secrets/keyvault-managed/databricks-host}}"
      ENVIRONMENT: ${bundle.target.name}
      DOMAIN: bds
      DATABRICKS_TOKEN: "{{secrets/keyvault-managed/dbx-sp-access-token}}"
      DD_API_KEY: "{{secrets/keyvault-managed/dd-api-key}}"
    spark_version: 12.2.x-scala2.12
    autoscale:
      min_workers: 1
      max_workers: 3
    azure_attributes:
      availability: ON_DEMAND_AZURE
      first_on_demand: 1
    node_type_id: Standard_DS3_v2
    data_security_mode: SINGLE_USER
    runtime_engine: STANDARD

# permissions:
#   - level: CAN_MANAGE
#     # service_principal_name: "8b44e547-62e3-48bc-b34e-8374a4639206"
#     service_principal_name: "${{ secrets.DBX_SP_APP_ID_DEV }}"

# resources:
#   jobs:
#     inference_job:
#       name: BDS-QA-SMOKE-JOB
#       job_clusters:
#         - job_cluster_key: DBX-BDS-QA-BUNDLE-CLUSTER
#           new_cluster:
#             num_workers: 1
#             spark_version: 14.3.x-scala2.12
#             node_type_id: Standard_DS3_v2
#       tasks:
#         - task_key: CHECK-BDS-QA-METADATA-TABLES
#           job_cluster_key: DBX-BDS-QA-BUNDLE-CLUSTER
#           notebook_task:
#             notebook_path: ./src/main/metadata_tables_check.ipynb

# workspace:
#   root_path: /Users/${workspace.current_user.userName}/.bundle/${bundle.name}/my-envs/${bundle.target}

targets:
  dev:
    default: true
    # variables:
    #   # ENV_NAME: "dev"
    #   BUNDLE_VAR_ENV_NAME: "$BUNDLE_VAR_ENV_NAME"
    #   ENV_NAME: "DBX Variables"

    permissions:
      - level: CAN_MANAGE
        service_principal_name: "8b44e547-62e3-48bc-b34e-8374a4639206"
        # service_principal_name: "$AZ_SPN_APP_ID"
    resources:
      jobs:
        welcome-job:
          job_clusters:
            - job_cluster_key: BDS-QA-AUTOMATION-JOB-CLUSTER
              <<: *job_cluster
          # BDS-QA-AUTOMATION-JOB:
          schedule:
            quartz_cron_expression: 0 0 0/6 * * ?
            timezone_id: UTC
            pause_status: UNPAUSED
  stage:
    default: false
  production:
    default: false
